#
#
#
#                          Diamond 1.0
# 
#            Copyright (c) 2002-2004, Intel Corporation
#                         All Rights Reserved
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
# 
#    * Redistributions of source code must retain the above copyright
#      notice, this list of conditions and the following disclaimer.
#
#    * Redistributions in binary form must reproduce the above
#      copyright notice, this list of conditions and the following
#      disclaimer in the documentation and/or other materials provided
#      with the distribution.
#
#    * Neither the name of Intel nor the names of its contributors may
#      be used to endorse or promote products derived from this software 
#      without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

BUILD_LIB_PATH = $(DIAMOND_ROOT)/target/lib
BUILD_INC_PATH = $(DIAMOND_ROOT)/target/include
BUILD_BIN_PATH = $(DIAMOND_ROOT)/target/bin

INCDIR += -I${BUILD_INC_PATH}

LIBDIR += -L${BUILD_LIB_PATH}


# general flags
CFLAGS += -O2
CFLAGS += -ggdb
CFLAGS += -DDEBUG 
CFLAGS += -Wall

# un-comment if you want profiling
#CFLAGS += -pg 


# The tools we want to use to compile
FLEX = flex
AWK = gawk
CC = gcc
CPLUSPLUS = g++


#Just to go overboard and be sure
CFLAGS += -D_REENTRANT
CFLAGS += -D_THREAD_SAFE

MKDIR = mkdir

#
# Other misc objects to remove during a make clean operation.
# For now we remove profiling object (gmon.out) and any core
# files that have been generated.
#

CLEAN_OTHERS += gmon.out core.* *.core filters.gviz filters.daVinci

#
# Objects to remove during "distclean".  For now just the .depend
#
DIST_OBJS += .depend

%.o: %.S
	${CPP} $(filter -I% -D%, ${INCDIR} ${CFLAGS}) $< | \
		${AS} ${ALL_ASFLAGS} -o $@
%.o: %.s
	${CPP} -E $(filter -I% -D%, ${INCDIR} ${CFLAGS}) $< | \
		${AS} ${ALL_ASFLAGS} -o $@
	@${LD} -x -r $@
	@${MV} a.out $@

%.o: %.c
	${CC} ${INCDIR} ${CFLAGS} -c $< -o $@

%.o: %.cc
	${CPLUSPLUS} ${INCDIR} ${CFLAGS} -c $< -o $@

%.a: $(LIBOBJS)
	rm -f $@ 
	ar -csr $@  $^
	cp -f $@ ${BUILD_LIB_PATH}

# The common targets

.PHONY :  all depend clean installdirs install mail FORCE

#
#  Define a do-subdirs function to execute recursive targets such as "all"
#  and clean. It calls "make" on each of the directories listed in SUBDIRS
#
ifndef do-subdirs
define do-subdirs
	@for entry in ${SUBDIRS}; do \
		(if test -d $${entry}; then \
			${MAKE} -C $${entry} $@; \
		else \
			echo "*** Warning:  couldn't find subdir $${entry}"; \
		fi); \
	done
endef
endif



TARGETS += copyheader 

#  Rebuild everything, which is the program "PROG" and its 
#	subdirectories "SUBDIRS" 
#

#   Note: the "+" in front of a commmand makes the command happen
#  	even when the user has specified "make -n" 

all: ${SRCS} ${HSRCS} ${SSRCS} ${OSRCS} ${CYSRCS} ${HYSRCS} ${CLSRCS} ${PROG} ${TARGETS} ${SUBDIRS}
	${do-subdirs}


#
# Make the dependencies for this directory and its children
#
depend: 
ifneq ($(strip ${SRCS}),)
	${CC} -E -M ${INCDIR} ${CFLAGS} ${SRCS} > .depend
endif
	${do-subdirs}	


#
# Clean up the objects and binary in this directory and its children
#
clean: 
ifneq ($(strip ${OBJS} ${PROG} ${CLEAN_OTHERS} $(TARGETS)),)
	${RM} ${OBJS} $(TARGETS) $(PROG) $(CLEAN_OTHERS)
endif
	${do-subdirs}


#
# Clean up the objects and binary in this directory and its children
#
distclean: 
ifneq ($(strip ${OBJS} ${PROG} $(CLEAN_OTHERS) $(TARGETS) $(DIST_OBJS)),)
	${RM} ${OBJS} $(TARGETS) ${PROG} $(CLEAN_OTHERS) $(DIST_OBJS)
endif
	${do-subdirs}

copyheader:
	@for entry in ${SHARED_HEADERS} ; do \
		echo copying $${entry}; \
		cp -f $${entry} ${BUILD_INC_PATH}; \
	done



#  Install the program, and its children

ifndef INSTALLDIR
INSTALLDIR=${DIAMOND_ROOT}/build
endif
ifndef INSTALLDIR_BIN
INSTALLDIR_BIN=${INSTALLDIR}/bin
endif
ifndef INSTALLDIR_LIB
INSTALLDIR_LIB=${INSTALLDIR}/lib
endif
ifndef INSTALLDIR_INCLUDE
INSTALLDIR_INCLUDE=${INSTALLDIR}/include
endif

# Installs must get done as root, but we don't need to test here since 
# installdirs will do it.  Note that local Makefiles should also perform
# this check iff they define their own installdirs target.
install: installdirs
ifneq ($(strip ${PROG}),)
	${INSTALL_BIN} ${PROG} ${INSTALLDIR_BIN}
endif
ifneq ($(strip ${INSTALL_OTHERS}),)	
	${INSTALL} ${INSTALL_OTHERS} ${INSTALLDIR}
endif



# Make copies as needed.
ifdef COPIES
	@for copyit in ${COPIES}; do \
		echo Creating copy of ${PROG} ; \
		cd ${COPYDIR} ; \
		${CP} ${INSTALLDIR_BIN}/${PROG} $${copyit} ; \
	done
endif

	${do-subdirs}



#  Create the directories to install into

ALL_INSTALLDIRS= ${INSTALLDIR} ${INSTALLDIR_BIN} ${INSTALLDIR_LIB} ${INSTALLDIR_INCLUDE}
installdirs:
	${TESTROOT}
	@for entry in ${ALL_INSTALLDIRS} ; do \
		(if ! test -d $${entry}; then \
			echo Creating directory $${entry} ; \
			${MKDIR} $${entry} ; \
		fi); \
	done
	${do-subdirs}



#
# Inlude the dependancies that were included earlier.
-include .depend

FORCE:

