<!doctype html>
<title>Search Results</title>
<script type="text/javascript" src="{{ static_url('testui/jquery.js') }}"></script>
<script type="text/javascript" src="{{ static_url('sockjs.js') }}"></script>

<style type="text/css">
#statistics {
  position: fixed;
  top: 0;
  left: 0;
  padding: 0.3em;
  width: 100%;
  background-color: #ddd;
  font-weight: bold;
  text-align: center;
}

#results {
  padding-top: 2em;
  padding-left: 0;
  margin-left: 0;
}

#results li {
  list-style-type: none;
  float: left;
}
</style>

<div id="content">
<div id="statistics">
Initializing...
</div>
<ul id="results">
</ul>
</div>

<script type="text/javascript">
$(function() {
  var status = window.location.hash[1];
  var data = window.location.hash.slice(2);

  function make_sock(url) {
    var sock = new SockJS(url);
    var handlers = {};

    sock.onmessage = function(ev) {
      var msg = JSON.parse(ev.data);
      if (typeof(handlers[msg.event]) === 'function') {
        handlers[msg.event](msg.data);
      }
    };

    sock.on = function(event, func) {
      handlers[event] = func;
    };

    sock.emit = function(event, data)  {
      sock.send(JSON.stringify({
        'event': event,
        'data': data
      }));
    };

    return sock;
  }

  if (status === 'e') {
    // Error
    $('#content').text('Error: ' + unescape(data));
  } else {
    // Success
    var sock = make_sock('/search');
    var search_key = data;
    var paused = false;
    var MAX_UNEXPOSED = 50;

    function pause() {
      if (!paused) {
        paused = true;
        sock.emit('pause');
      }
    }

    function resume() {
      if (paused) {
        paused = false;
        sock.emit('resume');
      }
    }

    function is_unexposed(jq) {
      return jq.offset().top > $(document).scrollTop() + $(window).height();
    }

    function update_exposed() {
      $('.unexposed').each(function(i, el) {
        if (!is_unexposed($(el))) {
          $(el).removeClass('unexposed');
        }
      });
      if (paused && $('.unexposed').length < MAX_UNEXPOSED) {
        resume();
      }
    }

    sock.onopen = function() {
      sock.emit('start', {
        'search_key': search_key
      });
    };

    sock.on('result', function(data) {
      var thumbnail = data['thumbnail.jpeg'];
      var image_url;
      if (thumbnail) {
        image_url = thumbnail.image_url;
      } else {
        image_url = "{{ static_url('testui/unknown.png') }}";
      }
      var jq = $('<li><a target="_blank"><img></a></li>');
      jq.find('a').attr('href', '{{ result_url }}#' + data._ResultURL.data);
      jq.find('img').attr('src', image_url);
      $('#results').append(jq);
      if (is_unexposed(jq)) {
        jq.addClass('unexposed');
      }
      if (!paused && $('.unexposed').length >= MAX_UNEXPOSED) {
        pause();
      }
    });

    sock.on('statistics', function(data) {
      $('#statistics').text(data.objs_processed + '/' + data.objs_total +
          ' objects processed');
    });

    $(window).resize(update_exposed);
    $(window).scroll(update_exposed);
  }
});
</script>
