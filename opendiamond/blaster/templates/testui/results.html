<!doctype html>
<title>Search Results</title>
<script type="text/javascript" src="{{ static_url('testui/jquery.js') }}"></script>
<script type="text/javascript" src="{{ static_url('sockjs.js') }}"></script>

<style type="text/css">
</style>

<div id="content">
<ul id="results">
</ul>
</div>

<script type="text/javascript">
$(function() {
  var status = window.location.hash[1];
  var data = window.location.hash.slice(2);

  function make_sock(url) {
    var sock = new SockJS(url);
    var handlers = {};

    sock.onmessage = function(ev) {
      var msg = JSON.parse(ev.data);
      if (typeof(handlers[msg.event]) === 'function') {
        handlers[msg.event](msg.data);
      }
    };

    sock.on = function(event, func) {
      handlers[event] = func;
    };

    sock.emit = function(event, data)  {
      sock.send(JSON.stringify({
        'event': event,
        'data': data
      }));
    };

    return sock;
  }

  if (status === 'e') {
    // Error
    $('#content').text('Error: ' + unescape(data));
  } else {
    // Success
    var sock = make_sock('/search');
    var search_key = data;
    var paused = false;
    var MAX_UNEXPOSED = 50;

    function pause() {
      if (!paused) {
        paused = true;
        sock.emit('pause');
      }
    }

    function resume() {
      if (paused) {
        paused = false;
        sock.emit('resume');
      }
    }

    function is_unexposed(jq) {
      return jq.offset().top > $(document).scrollTop() + $(window).height();
    }

    function update_exposed() {
      $('.unexposed').each(function(i, el) {
        if (!is_unexposed($(el))) {
          $(el).removeClass('unexposed');
        }
      });
      if (paused && $('.unexposed').length < MAX_UNEXPOSED) {
        resume();
      }
    }

    sock.onopen = function() {
      sock.emit('start', {
        'search_key': search_key
      });
      $('#results').html('');
    };

    sock.on('result', function(data) {
      var jq = $('<li>' + data._ObjectID + '</li>');
      $('#results').append(jq);
      if (is_unexposed(jq)) {
        jq.addClass('unexposed');
      }
      if (!paused && $('.unexposed').length >= MAX_UNEXPOSED) {
        pause();
      }
    });

    $(window).resize(update_exposed);
    $(window).scroll(update_exposed);
  }
});
</script>
