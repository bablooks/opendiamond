<!doctype html>
<title>Search Results</title>
<script type="text/javascript" src="{{ static_url('testui/jquery.js') }}"></script>
<script type="text/javascript" src="{{ static_url('testui/socket.io.js') }}"></script>

<style type="text/css">
</style>

<div id="content">
<ul id="results">
</ul>
</div>

<script type="text/javascript">
$(function() {
  var status = window.location.hash[1];
  var data = window.location.hash.slice(2);

  if (status === 'e') {
    // Error
    $('#content').text('Error: ' + unescape(data));
  } else {
    // Success
    var sock = io.connect('/search');
    var search_key = data;
    var paused = false;
    var MAX_UNEXPOSED = 50;

    function pause() {
      if (!paused) {
        paused = true;
        sock.emit('pause');
      }
    }

    function resume() {
      if (paused) {
        paused = false;
        sock.emit('resume');
      }
    }

    function is_unexposed(jq) {
      return jq.offset().top > $(document).scrollTop() + $(window).height();
    }

    function update_exposed() {
      $('.unexposed').each(function(i, el) {
        if (!is_unexposed($(el))) {
          $(el).removeClass('unexposed');
        }
      });
      if (paused && $('.unexposed').length < MAX_UNEXPOSED) {
        resume();
      }
    }

    sock.on('connect', function() {
      sock.emit('start', search_key);
      $('#results').html('');
    });

    sock.on('result', function(data) {
      var jq = $('<li>' + data.search_key + ' ' + data.count + '</li>');
      $('#results').append(jq);
      if (is_unexposed(jq)) {
        jq.addClass('unexposed');
      }
      if (!paused && $('.unexposed').length >= MAX_UNEXPOSED) {
        pause();
      }
    });

    $(window).resize(update_exposed);
    $(window).scroll(update_exposed);
  }
});
</script>
